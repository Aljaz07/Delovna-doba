<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Delovni ƒåas Igrica - Izpis, Nadure, Dnevne Misije</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      overflow-x: hidden;
      color: white;
      position: relative;
    }
    #canvas-bg {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -10;
      display: block;
    }
    .popup {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%) scale(0);
      background: #22c55e;
      padding: 20px 30px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 8px 15px rgba(34, 197, 94, 0.6);
      color: white;
      font-size: 1.25rem;
      user-select: none;
      pointer-events: none;
      z-index: 1000;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .popup.show {
      transform: translateX(-50%) scale(1);
      pointer-events: auto;
      animation: pulseGlow 1.5s ease-in-out infinite alternate;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 8px 4px #22c55e; }
      100% { box-shadow: 0 0 18px 8px #4ade80; }
    }
    label {
      user-select: none;
    }
    select, input[type="date"] {
      background: white;
    }
    /* Scroll box for entries */
    #entries-list {
      max-height: 220px;
      overflow-y: auto;
      background: #1e293b;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.9rem;
      user-select: text;
    }
    #entries-list table {
      width: 100%;
      border-collapse: collapse;
    }
    #entries-list th, #entries-list td {
      border: 1px solid #334155;
      padding: 4px 8px;
      text-align: center;
    }
    #entries-list th {
      background-color: #334155;
    }
  </style>
</head>
<body>
  <canvas id="canvas-bg"></canvas>

  <div class="max-w-xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold tracking-wide">Delovni ƒåas Igrica</h1>
        <p class="text-green-400 font-semibold">Stopnja, EXP in delovna doba</p>
      </div>
      <img id="avatar" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Player" alt="Avatar" class="w-20 h-20 rounded-full border-4 border-green-400 cursor-pointer hover:scale-105 transition-transform" title="Klikni za random avatar" />
    </header>

    <section id="stats" class="bg-gray-800 rounded-lg p-4 space-y-2 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold">Level: <span id="level-display">1</span></h2>
          <div class="text-sm">EXP: <span id="exp-display">0 / 100</span></div>
          <div class="w-full bg-gray-700 rounded h-3 mt-1 overflow-hidden">
            <div id="exp-bar" class="bg-green-400 h-3 rounded transition-all duration-300" style="width: 0%;"></div>
          </div>
        </div>
      </div>

      <div>
        <p>Skupaj ur: <span id="total-hours">0</span></p>
        <p>Skupaj dni: <span id="total-days">0</span></p>
        <p>Delovna doba: <span id="work-years">0</span> let, <span id="work-months">0</span> mesecev</p>
        <p>Nadure danes: <span id="overtime-today">0</span> minut</p>
      </div>
    </section>

    <section id="daily-mission" class="bg-gray-800 rounded-lg p-4 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">üéØ Dnevna naloga</h3>
      <p id="mission-text">Naloga</p>
      <p>Napredek: <span id="mission-progress">0 / 1</span></p>
      <p>Nagrada: <span id="mission-exp">50</span> EXP</p>
      <button id="reset-mission" class="mt-3 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 rounded font-semibold">Ponastavi misijo (test)</button>
    </section>

    <section id="work-entry" class="bg-gray-800 rounded-lg p-4 shadow-lg space-y-3">
      <h3 class="text-lg font-semibold">üìÖ Vnos Delovnega Dne</h3>
      <input id="date-input" type="date" class="w-full p-2 rounded text-black" />

      <div class="flex space-x-2">
        <div class="flex flex-col w-1/2">
          <label for="start-hour" class="text-white mb-1 select-none">Zaƒçetek ura</label>
          <select id="start-hour" class="p-2 rounded text-black"></select>
        </div>
        <div class="flex flex-col w-1/2">
          <label for="start-minute" class="text-white mb-1 select-none">Zaƒçetek minuta</label>
          <select id="start-minute" class="p-2 rounded text-black"></select>
        </div>
      </div>

      <div class="flex space-x-2">
        <div class="flex flex-col w-1/2">
          <label for="end-hour" class="text-white mb-1 select-none">Konec ura</label>
          <select id="end-hour" class="p-2 rounded text-black"></select>
        </div>
        <div class="flex flex-col w-1/2">
          <label for="end-minute" class="text-white mb-1 select-none">Konec minuta</label>
          <select id="end-minute" class="p-2 rounded text-black"></select>
        </div>
      </div>

      <button onclick="addRealEntry()" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded font-semibold">Shrani Dan</button>
    </section>

    <section id="achievements-section" class="bg-gray-800 rounded-lg p-4 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">üèÖ Dose≈æki</h3>
      <ul id="achievements" class="list-disc ml-5 max-h-40 overflow-y-auto"></ul>
    </section>

    <section id="entries-section" class="bg-gray-800 rounded-lg p-4 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">üìù Izpis dnevnih vnosov</h3>
      <div id="entries-list"></div>
    </section>

  </div>

  <div id="popup" class="popup"></div>

  <audio id="level-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3"></audio>
  <audio id="mission-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-win-video-game-notification-269.mp3"></audio>

  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>

  <script>
    // --- Three.js 3D background ---
    const canvas = document.getElementById('canvas-bg');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.z = 4;

    const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
    const material = new THREE.MeshPhongMaterial({
      color: 0x22c55e,
      emissive: 0x104010,
      shininess: 100,
      flatShading: true,
    });
    const mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);

    const light = new THREE.DirectionalLight(0x22c55e, 1);
    light.position.set(10, 10, 10);
    scene.add(light);

    function animate() {
      mesh.rotation.x += 0.002;
      mesh.rotation.y += 0.004;
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    // --- Variables & Constants ---
    const avatar = document.getElementById('avatar');
    const popup = document.getElementById('popup');
    const levelDisplay = document.getElementById('level-display');
    const expDisplay = document.getElementById('exp-display');
    const expBar = document.getElementById('exp-bar');
    const totalHoursDisplay = document.getElementById('total-hours');
    const totalDaysDisplay = document.getElementById('total-days');
    const workYearsDisplay = document.getElementById('work-years');
    const workMonthsDisplay = document.getElementById('work-months');
    const missionText = document.getElementById('mission-text');
    const missionProgress = document.getElementById('mission-progress');
    const missionExp = document.getElementById('mission-exp');
    const resetMissionBtn = document.getElementById('reset-mission');
    const achievementsList = document.getElementById('achievements');
    const levelSound = document.getElementById('level-sound');
    const missionSound = document.getElementById('mission-sound');
    const entriesList = document.getElementById('entries-list');
    const overtimeTodayDisplay = document.getElementById('overtime-today');

    // EXP required per level (simple formula or fixed)
    function expForLevel(level) {
      return 100 + (level - 1) * 50;
    }

    // Mission pool - vsak dan druga misija, ki se ponavlja v ciklu
    const missionPool = [
      { description: "Dodaj vsaj 1 vnos danes", goal: 1, rewardExp: 50, type: "addEntries" },
      { description: "Dose≈æi vsaj 8 ur dela danes", goal: 8*60, rewardExp: 80, type: "workMinutes" },
      { description: "Naredi 1 vnos z nadurami", goal: 1, rewardExp: 60, type: "overtimeEntry" },
      { description: "Dodaj vsaj 3 vnose danes", goal: 3, rewardExp: 120, type: "addEntries" },
      { description: "Skupaj 40 ur ta teden", goal: 40*60, rewardExp: 150, type: "weeklyMinutes" },
    ];

    // Stored data keys
    const STORAGE_KEY = 'workGameData';

    // Load saved game data or default
    let gameData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
      level: 1,
      exp: 0,
      totalHours: 0,
      totalDays: 0,
      totalMinutes: 0,
      achievements: [],
      entries: []
    };

    // --- Initialize UI ---
    function populateTimeSelectors() {
      const startHour = document.getElementById('start-hour');
      const endHour = document.getElementById('end-hour');
      const startMinute = document.getElementById('start-minute');
      const endMinute = document.getElementById('end-minute');

      for(let h=0; h<24; h++) {
        const optionStartH = document.createElement('option');
        optionStartH.value = h;
        optionStartH.textContent = h.toString().padStart(2, '0');
        startHour.appendChild(optionStartH);

        const optionEndH = document.createElement('option');
        optionEndH.value = h;
        optionEndH.textContent = h.toString().padStart(2, '0');
        endHour.appendChild(optionEndH);
      }

      for(let m=0; m<60; m+=5) {
        const optionStartM = document.createElement('option');
        optionStartM.value = m;
        optionStartM.textContent = m.toString().padStart(2, '0');
        startMinute.appendChild(optionStartM);

        const optionEndM = document.createElement('option');
        optionEndM.value = m;
        optionEndM.textContent = m.toString().padStart(2, '0');
        endMinute.appendChild(optionEndM);
      }

      // Default times
      startHour.value = 8;
      startMinute.value = 0;
      endHour.value = 16;
      endMinute.value = 0;
    }

    // --- EXP and Leveling ---
    function addExp(amount) {
      gameData.exp += amount;

      let currentLevelExp = expForLevel(gameData.level);
      while(gameData.exp >= currentLevelExp) {
        gameData.exp -= currentLevelExp;
        gameData.level++;
        currentLevelExp = expForLevel(gameData.level);
        levelSound.play();
        showPopup(`ƒåestitke! Dosegel si nivo ${gameData.level}! üéâ`);
      }

      updateStatsUI();
      saveGame();
    }

    // --- Popup notifications ---
    let popupTimeout;
    function showPopup(message) {
      popup.textContent = message;
      popup.classList.add('show');
      clearTimeout(popupTimeout);
      popupTimeout = setTimeout(() => {
        popup.classList.remove('show');
      }, 2500);
    }

    // --- Avatar randomizer ---
    avatar.onclick = () => {
      const seed = Math.random().toString(36).substring(2,8);
      avatar.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}`;
      showPopup("Avatar spremenjen");
    };

    // --- Add work entry ---
    function addRealEntry() {
      const dateInput = document.getElementById('date-input').value;
      const sh = parseInt(document.getElementById('start-hour').value);
      const sm = parseInt(document.getElementById('start-minute').value);
      const eh = parseInt(document.getElementById('end-hour').value);
      const em = parseInt(document.getElementById('end-minute').value);

      if (!dateInput) {
        alert('Izberi datum');
        return;
      }

      // Validate times
      const startTotal = sh * 60 + sm;
      const endTotal = eh * 60 + em;
      if (endTotal <= startTotal) {
        alert('Konec mora biti po zaƒçetku!');
        return;
      }

      // Calculate duration in minutes
      const duration = endTotal - startTotal;

      // Add entry
      gameData.entries.push({
        date: dateInput,
        startHour: sh,
        startMinute: sm,
        endHour: eh,
        endMinute: em,
        duration: duration
      });

      // Update total time and days
      gameData.totalMinutes += duration;

      // Count unique days
      const uniqueDates = new Set(gameData.entries.map(e => e.date));
      gameData.totalDays = uniqueDates.size;

      updateStatsUI();

      // Update mission progress for today's missions
      checkDailyMissions(dateInput);

      saveGame();
      showPopup('Vnos dodan');
      resetEntryFields();
      renderEntriesList();
    }

    function resetEntryFields() {
      // Reset inputs to default
      document.getElementById('date-input').value = new Date().toISOString().slice(0,10);
      document.getElementById('start-hour').value = 8;
      document.getElementById('start-minute').value = 0;
      document.getElementById('end-hour').value = 16;
      document.getElementById('end-minute').value = 0;
    }

    // --- Entries list rendering ---
    function renderEntriesList() {
      if (gameData.entries.length === 0) {
        entriesList.innerHTML = '<p class="text-center text-gray-400">Ni vnosov.</p>';
        return;
      }
      // Razvrsti po datumu in zaƒçetku ure
      const sortedEntries = [...gameData.entries].sort((a,b) => {
        if (a.date === b.date) {
          return (a.startHour*60 + a.startMinute) - (b.startHour*60 + b.startMinute);
        }
        return a.date.localeCompare(b.date);
      });

      let html = `<table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Zaƒçetek</th>
            <th>Konec</th>
            <th>Trajanje (min)</th>
            <th>Nadure (min)</th>
          </tr>
        </thead><tbody>`;

      for (const entry of sortedEntries) {
        const duration = entry.duration;
        // Nadure = trajanje nad 8 ur (480 min)
        let overtime = 0;
        if (duration > 480) {
          overtime = duration - 480;
        }
        html += `<tr>
          <td>${entry.date}</td>
          <td>${entry.startHour.toString().padStart(2,'0')}:${entry.startMinute.toString().padStart(2,'0')}</td>
          <td>${entry.endHour.toString().padStart(2,'0')}:${entry.endMinute.toString().padStart(2,'0')}</td>
          <td>${duration}</td>
          <td>${overtime}</td>
        </tr>`;
      }

      html += '</tbody></table>';

      entriesList.innerHTML = html;

      // Izpi≈°i nadure danes posebej (skupaj)
      const today = new Date().toISOString().slice(0,10);
      const todaysEntries = gameData.entries.filter(e => e.date === today);
      let todaysOvertime = 0;
      for (const e of todaysEntries) {
        if (e.duration > 480) {
          todaysOvertime += e.duration - 480;
        }
      }
      overtimeTodayDisplay.textContent = todaysOvertime;
    }

    // --- Stats UI update ---
    function updateStatsUI() {
      levelDisplay.textContent = gameData.level;
      expDisplay.textContent = `${gameData.exp} / ${expForLevel(gameData.level)}`;
      expBar.style.width = (gameData.exp / expForLevel(gameData.level) * 100) + '%';
      totalHoursDisplay.textContent = Math.floor(gameData.totalMinutes / 60);
      totalDaysDisplay.textContent = gameData.totalDays;

      // Calculate work years and months (assuming 2000 work hours = 1 year)
      const workHours = gameData.totalMinutes / 60;
      const years = Math.floor(workHours / 2000);
      const months = Math.floor((workHours % 2000) / (2000/12));
      workYearsDisplay.textContent = years;
      workMonthsDisplay.textContent = months;

      // Achievements
      renderAchievements();
    }

    // --- Achievements rendering ---
    function renderAchievements() {
      achievementsList.innerHTML = '';
      for (const ach of gameData.achievements) {
        const li = document.createElement('li');
        li.textContent = ach;
        achievementsList.appendChild(li);
      }
    }

    // --- Daily mission system ---
    // Shranimo trenutno misijo v localStorage z datumom
    function getTodayMission() {
      const today = new Date().toISOString().slice(0,10);
      const missionIndex = (new Date().getDate() + new Date().getMonth()) % missionPool.length;
      return missionPool[missionIndex];
    }

    function loadMissionProgress() {
      const today = new Date().toISOString().slice(0,10);
      const stored = JSON.parse(localStorage.getItem('missionProgress'));
      if (stored && stored.date === today) {
        return stored;
      }
      return { date: today, progress: 0, completed: false };
    }

    let currentMission = getTodayMission();
    let missionData = loadMissionProgress();

    function updateMissionUI() {
      missionText.textContent = currentMission.description;
      missionProgress.textContent = `${missionData.progress} / ${currentMission.goal}`;
      missionExp.textContent = currentMission.rewardExp;
    }

    function saveMissionProgress() {
      localStorage.setItem('missionProgress', JSON.stringify(missionData));
    }

    // Check mission progress when adding entries
    function checkDailyMissions(todayDate) {
      if (missionData.completed) return;

      switch(currentMission.type) {
        case "addEntries":
          // ≈†tej vnose za dana≈°nji dan
          const todayEntriesCount = gameData.entries.filter(e => e.date === todayDate).length;
          if (todayEntriesCount >= currentMission.goal) {
            missionData.progress = currentMission.goal;
            completeMission();
          } else {
            missionData.progress = todayEntriesCount;
          }
          break;

        case "workMinutes":
          // ≈†tej skupno trajanje za dana≈°nji dan
          const todayEntries = gameData.entries.filter(e => e.date === todayDate);
          let totalMinutes = 0;
          for (const e of todayEntries) totalMinutes += e.duration;
          if (totalMinutes >= currentMission.goal) {
            missionData.progress = currentMission.goal;
            completeMission();
          } else {
            missionData.progress = totalMinutes;
          }
          break;

        case "overtimeEntry":
          // Poi≈°ƒçi vnose z nadurami danes
          const overtimeEntries = gameData.entries.filter(e => e.date === todayDate && e.duration > 480);
          if (overtimeEntries.length >= currentMission.goal) {
            missionData.progress = currentMission.goal;
            completeMission();
          } else {
            missionData.progress = overtimeEntries.length;
          }
          break;

        case "weeklyMinutes":
          // Sumiraj od ponedeljka do danes
          const todayDateObj = new Date(todayDate);
          const dayOfWeek = todayDateObj.getDay(); // 0=nedelja
          const monday = new Date(todayDateObj);
          monday.setDate(todayDateObj.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

          let weeklyMinutes = 0;
          for (const e of gameData.entries) {
            const eDate = new Date(e.date);
            if (eDate >= monday && eDate <= todayDateObj) {
              weeklyMinutes += e.duration;
            }
          }
          if (weeklyMinutes >= currentMission.goal) {
            missionData.progress = currentMission.goal;
            completeMission();
          } else {
            missionData.progress = weeklyMinutes;
          }
          break;
      }

      updateMissionUI();
      saveMissionProgress();
    }

    function completeMission() {
      missionData.completed = true;
      addExp(currentMission.rewardExp);
      missionSound.play();
      showPopup(`Misija konƒçana! +${currentMission.rewardExp} EXP`);
      // Dodaj dose≈æek
      const achText = `Konƒçal misijo: "${currentMission.description}"`;
      if (!gameData.achievements.includes(achText)) {
        gameData.achievements.push(achText);
        saveGame();
        renderAchievements();
      }
    }

    resetMissionBtn.onclick = () => {
      missionData = { date: new Date().toISOString().slice(0,10), progress: 0, completed: false };
      saveMissionProgress();
      updateMissionUI();
      showPopup('Misija ponastavljena');
    };

    // --- Save game ---
    function saveGame() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData));
    }

    // --- Initialize ---
    function init() {
      populateTimeSelectors();
      resetEntryFields();
      updateStatsUI();
      renderEntriesList();
      updateMissionUI();
      // Nastavi dana≈°nji datum v inputu
      document.getElementById('date-input').value = new Date().toISOString().slice(0,10);
      // Obnova misije in izraƒçun napredka za danes
      checkDailyMissions(new Date().toISOString().slice(0,10));
    }

    init();
  </script>
</body>
</html>
