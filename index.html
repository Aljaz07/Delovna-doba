<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Delovni ƒåas Igrica - Izpis, Nadure, Dnevne Misije</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      overflow-x: hidden;
      color: white;
      position: relative;
    }
    #canvas-bg {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -10;
      display: block;
    }
    .popup {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%) scale(0);
      background: #22c55e;
      padding: 20px 30px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 8px 15px rgba(34, 197, 94, 0.6);
      color: white;
      font-size: 1.25rem;
      user-select: none;
      pointer-events: none;
      z-index: 1000;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .popup.show {
      transform: translateX(-50%) scale(1);
      pointer-events: auto;
      animation: pulseGlow 1.5s ease-in-out infinite alternate;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 8px 4px #22c55e; }
      100% { box-shadow: 0 0 18px 8px #4ade80; }
    }
    label {
      user-select: none;
    }
    select, input[type="date"] {
      background: white;
    }
    /* Scroll box for entries */
    #entries-list {
      max-height: 220px;
      overflow-y: auto;
      background: #1e293b;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.9rem;
      user-select: text;
    }
    #entries-list table {
      width: 100%;
      border-collapse: collapse;
    }
    #entries-list th, #entries-list td {
      border: 1px solid #334155;
      padding: 4px 8px;
      text-align: center;
    }
    #entries-list th {
      background-color: #334155;
    }
  </style>
</head>
<body>
  <canvas id="canvas-bg"></canvas>

  <div class="max-w-xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold tracking-wide">Delovni ƒåas Igrica</h1>
        <p class="text-green-400 font-semibold">Stopnja, EXP in delovna doba</p>
      </div>
      <img id="avatar" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Player" alt="Avatar" class="w-20 h-20 rounded-full border-4 border-green-400 cursor-pointer hover:scale-105 transition-transform" title="Klikni za random avatar" />
    </header>

    <section id="stats" class="bg-gray-800 rounded-lg p-4 space-y-2 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold">Level: <span id="level-display">1</span></h2>
          <div class="text-sm">EXP: <span id="exp-display">0 / 100</span></div>
          <div class="w-full bg-gray-700 rounded h-3 mt-1 overflow-hidden">
            <div id="exp-bar" class="bg-green-400 h-3 rounded transition-all duration-300" style="width: 0%;"></div>
          </div>
        </div>
      </div>

      <div>
        <p>Skupaj ur: <span id="total-hours">0</span></p>
        <p>Skupaj dni: <span id="total-days">0</span></p>
        <p>Delovna doba: <span id="work-years">0</span> let, <span id="work-months">0</span> mesecev</p>
        <p>Nadure danes: <span id="overtime-today">0</span> minut</p>
      </div>
    </section>

    <section id="daily-mission" class="bg-gray-800 rounded-lg p-4 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">üéØ Dnevna naloga</h3>
      <p id="mission-text">Naloga</p>
      <p>Napredek: <span id="mission-progress">0 / 1</span></p>
      <p>Nagrada: <span id="mission-exp">50</span> EXP</p>
      <button id="reset-mission" class="mt-3 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 rounded font-semibold">Ponastavi misijo (test)</button>
    </section>

    <section id="work-entry" class="bg-gray-800 rounded-lg p-4 shadow-lg space-y-3">
      <h3 class="text-lg font-semibold">üìÖ Vnos Delovnega Dne</h3>
      <input id="date-input" type="date" class="w-full p-2 rounded text-black" />

      <div class="flex space-x-2">
        <div class="flex flex-col w-1/2">
          <label for="start-hour" class="text-white mb-1 select-none">Zaƒçetek ura</label>
          <select id="start-hour" class="p-2 rounded text-black"></select>
        </div>
        <div class="flex flex-col w-1/2">
          <label for="start-minute" class="text-white mb-1 select-none">Zaƒçetek minuta</label>
          <select id="start-minute" class="p-2 rounded text-black"></select>
        </div>
      </div>

      <div class="flex space-x-2">
        <div class="flex flex-col w-1/2">
          <label for="end-hour" class="text-white mb-1 select-none">Konec ura</label>
          <select id="end-hour" class="p-2 rounded text-black"></select>
        </div>
        <div class="flex flex-col w-1/2">
          <label for="end-minute" class="text-white mb-1 select-none">Konec minuta</label>
          <select id="end-minute" class="p-2 rounded text-black"></select>
        </div>
      </div>

      <button onclick="addRealEntry()" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded font-semibold">Shrani Dan</button>
    </section>

    <section id="achievements-section" class="bg-gray-800 rounded-lg p-4 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">üèÖ Dose≈æki</h3>
      <ul id="achievements" class="list-disc ml-5 max-h-40 overflow-y-auto"></ul>
    </section>

    <section id="entries-section" class="bg-gray-800 rounded-lg p-4 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">üìù Izpis dnevnih vnosov</h3>
      <div id="entries-list"></div>
    </section>

  </div>

  <div id="popup" class="popup"></div>

  <audio id="level-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3"></audio>
  <audio id="mission-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-win-video-game-notification-269.mp3"></audio>

  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>

  <script>
    // --- Three.js 3D background ---
    const canvas = document.getElementById('canvas-bg');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.z = 4;

    const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
    const material = new THREE.MeshStandardMaterial({ color: 0x22c55e, emissive: 0x064e03, metalness: 0.8, roughness: 0.2 });
    const torusKnot = new THREE.Mesh(geometry, material);
    scene.add(torusKnot);

    const ambientLight = new THREE.AmbientLight(0x222222);
    scene.add(ambientLight);
    const pointLight = new THREE.PointLight(0x22c55e, 1);
    pointLight.position.set(5,5,5);
    scene.add(pointLight);

    function onResize() {
      const width = window.innerWidth;
      const height = window.innerHeight;
      renderer.setSize(width, height);
      camera.aspect = width/height;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', onResize);
    onResize();

    function animate() {
      torusKnot.rotation.x += 0.01;
      torusKnot.rotation.y += 0.01;
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    // --- App logic ---
    // Init hour and minute dropdowns
    function fillDropdown(id, max) {
      const select = document.getElementById(id);
      for(let i=0; i<=max; i++) {
        const val = i.toString().padStart(2, '0');
        const option = document.createElement('option');
        option.value = i;
        option.textContent = val;
        select.appendChild(option);
      }
    }
    fillDropdown('start-hour', 23);
    fillDropdown('start-minute', 59);
    fillDropdown('end-hour', 23);
    fillDropdown('end-minute', 59);

    // Popup helper
    function showPopup(msg, duration=2500) {
      const popup = document.getElementById('popup');
      popup.textContent = msg;
      popup.classList.add('show');
      setTimeout(() => popup.classList.remove('show'), duration);
    }

    // Avatar randomize
    const avatarImg = document.getElementById('avatar');
    avatarImg.addEventListener('click', () => {
      const seed = Math.random().toString(36).substring(2,10);
      avatarImg.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}`;
      showPopup('Avatar spremenjen!');
    });

    // Workday data storage in localStorage key 'workDays'
    // Format: { 'YYYY-MM-DD': { start: "HH:mm", end: "HH:mm", duration: minutes, overtime: minutes, weekend: bool, holiday: bool } }
    function loadWorkDays() {
      const raw = localStorage.getItem('workDays');
      return raw ? JSON.parse(raw) : {};
    }
    function saveWorkDays(data) {
      localStorage.setItem('workDays', JSON.stringify(data));
    }

    // Public API for work days
    let workDays = loadWorkDays();

    // Calculate duration and overtime
    function calcDuration(startH, startM, endH, endM) {
      let startTotal = startH*60 + startM;
      let endTotal = endH*60 + endM;
      if(endTotal < startTotal) {
        // next day scenario - for this app assume no overnight shifts
        return null;
      }
      let duration = endTotal - startTotal;
      let overtime = Math.max(0, duration - 480); // >8 hours is overtime in minutes
      return {duration, overtime};
    }

    // Weekend helper
    function isWeekend(dateStr) {
      const d = new Date(dateStr);
      return d.getDay() === 0 || d.getDay() === 6; // Sunday=0, Saturday=6
    }

    // Simple static holiday check (for demo)
    const holidays = [
      '2025-01-01', '2025-12-25', '2025-12-26'
    ];
    function isHoliday(dateStr) {
      return holidays.includes(dateStr);
    }

    // Add or update a workday entry
    function addRealEntry() {
      const date = document.getElementById('date-input').value;
      const sh = parseInt(document.getElementById('start-hour').value);
      const sm = parseInt(document.getElementById('start-minute').value);
      const eh = parseInt(document.getElementById('end-hour').value);
      const em = parseInt(document.getElementById('end-minute').value);

      if(!date) {
        alert('Izberi datum!');
        return;
      }

      const result = calcDuration(sh, sm, eh, em);
      if(result === null) {
        alert('Konec ne sme biti pred zaƒçetkom.');
        return;
      }

      const weekend = isWeekend(date);
      const holiday = isHoliday(date);

      workDays[date] = {
        start: `${sh.toString().padStart(2,'0')}:${sm.toString().padStart(2,'0')}`,
        end: `${eh.toString().padStart(2,'0')}:${em.toString().padStart(2,'0')}`,
        duration: result.duration,
        overtime: result.overtime,
        weekend, holiday
      };
      saveWorkDays(workDays);
      updateEntriesList();
      updateStats();
      checkMissionProgress(result.duration);
      showPopup(`Delovni ƒças za ${date} shranjen!`);
    }

    // Display all entries in table
    function updateEntriesList() {
      const container = document.getElementById('entries-list');
      if(Object.keys(workDays).length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400">Ni vnosov</p>';
        return;
      }
      let html = '<table><thead><tr><th>Datum</th><th>Start</th><th>Konec</th><th>Ure</th><th>Nadure</th><th>Vikend</th><th>Praznik</th></tr></thead><tbody>';
      const sortedDates = Object.keys(workDays).sort();
      sortedDates.forEach(date => {
        const e = workDays[date];
        html += `<tr>
          <td>${date}</td>
          <td>${e.start}</td>
          <td>${e.end}</td>
          <td>${(e.duration/60).toFixed(2)}</td>
          <td>${(e.overtime/60).toFixed(2)}</td>
          <td>${e.weekend ? 'Da' : 'Ne'}</td>
          <td>${e.holiday ? 'Da' : 'Ne'}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Stats and leveling system
    let exp = 0;
    let level = 1;
    let totalMinutes = 0;

    function updateStats() {
      totalMinutes = Object.values(workDays).reduce((sum,e) => sum + e.duration, 0);
      let totalDays = Object.keys(workDays).length;
      let totalHours = totalMinutes / 60;

      // Calculate level by exp, where each level requires level*100 exp
      // For simplicity, exp = totalMinutes / 10 + missionExp gained
      // Here we only count exp from working time and missions separately

      // Calculate exp from time: 1 exp per 10 minutes worked
      let expFromTime = Math.floor(totalMinutes / 10);

      // Calculate level based on total exp (expFromTime + missionExp)
      // missionExp stored in localStorage 'missionExp'
      const missionExpStored = parseInt(localStorage.getItem('missionExp') || '0');
      exp = expFromTime + missionExpStored;

      // Level calculation (progressive)
      let lvl = 1;
      let expNeeded = 100;
      while(exp >= expNeeded) {
        exp -= expNeeded;
        lvl++;
        expNeeded = lvl * 100;
      }
      level = lvl;

      // Update UI
      document.getElementById('level-display').textContent = level;
      document.getElementById('exp-display').textContent = `${exp} / ${level * 100}`;
      document.getElementById('exp-bar').style.width = `${(exp/(level*100))*100}%`;
      document.getElementById('total-hours').textContent = totalHours.toFixed(2);
      document.getElementById('total-days').textContent = totalDays;

      // Work experience: Convert total minutes to years and months (assume 2080 working hours/year)
      const totalHoursFloat = totalMinutes/60;
      const years = Math.floor(totalHoursFloat / 2080);
      const months = Math.floor((totalHoursFloat % 2080) / (2080/12));
      document.getElementById('work-years').textContent = years;
      document.getElementById('work-months').textContent = months;

      // Nadure today
      const today = new Date().toISOString().split('T')[0];
      const todayData = workDays[today];
      let overtimeToday = todayData ? todayData.overtime : 0;
      document.getElementById('overtime-today').textContent = overtimeToday;
    }

    // Mission system
    const missions = [
      {id:1, text: "Delaj vsaj 8 ur danes", condition: (day) => day.duration >= 480, exp: 50},
      {id:2, text: "Naredi 30 minut nadur", condition: (day) => day.overtime >= 30, exp: 80},
      {id:3, text: "Delaj v vikend", condition: (day) => day.weekend === true, exp: 100},
      {id:4, text: "Delaj praznik", condition: (day) => day.holiday === true, exp: 150},
      {id:5, text: "Naredi 10 ur delovnega ƒçasa", condition: (day) => day.duration >= 600, exp: 120}
    ];

    // Store current mission id in localStorage 'currentMission'
    // mission progress: store last completed date 'missionLastDate'
    function getCurrentMission() {
      const id = localStorage.getItem('currentMission');
      if(id) {
        const m = missions.find(m => m.id == id);
        if(m) return m;
      }
      // else assign random mission
      const m = missions[Math.floor(Math.random()*missions.length)];
      localStorage.setItem('currentMission', m.id);
      return m;
    }

    let currentMission = getCurrentMission();

    function updateMissionUI() {
      document.getElementById('mission-text').textContent = currentMission.text;
      document.getElementById('mission-exp').textContent = currentMission.exp;
      document.getElementById('mission-progress').textContent = '0 / 1';
    }

    function checkMissionProgress(durationToday) {
      // Check today's entry if mission condition met
      const today = new Date().toISOString().split('T')[0];
      const dayEntry = workDays[today];
      if(!dayEntry) return;

      if(currentMission.condition(dayEntry)) {
        // Completed mission, grant exp if not already today
        const lastDate = localStorage.getItem('missionLastDate');
        if(lastDate !== today) {
          // Grant exp
          let currentExp = parseInt(localStorage.getItem('missionExp') || '0');
          currentExp += currentMission.exp;
          localStorage.setItem('missionExp', currentExp);
          localStorage.setItem('missionLastDate', today);
          showPopup(`üéâ Naloga uspe≈°no opravljena! +${currentMission.exp} EXP`);
          document.getElementById('mission-progress').textContent = '1 / 1';
          playMissionSound();
          updateStats();
          addAchievement(`Opravil nalogo: ${currentMission.text}`);
          // Assign new mission
          currentMission = getCurrentMission();
          updateMissionUI();
        }
      } else {
        document.getElementById('mission-progress').textContent = '0 / 1';
      }
    }

    // Achievement system
    let achievements = JSON.parse(localStorage.getItem('achievements') || '[]');
    function addAchievement(text) {
      if(!achievements.includes(text)) {
        achievements.push(text);
        localStorage.setItem('achievements', JSON.stringify(achievements));
        updateAchievements();
        showPopup('üèÜ Dose≈æek dodan!');
      }
    }
    function updateAchievements() {
      const ul = document.getElementById('achievements');
      ul.innerHTML = '';
      achievements.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a;
        ul.appendChild(li);
      });
    }

    // Sounds
    const levelSound = document.getElementById('level-sound');
    const missionSound = document.getElementById('mission-sound');

    function playLevelSound() {
      levelSound.currentTime = 0;
      levelSound.play();
    }
    function playMissionSound() {
      missionSound.currentTime = 0;
      missionSound.play();
    }

    // Reset mission button (for testing)
    document.getElementById('reset-mission').addEventListener('click', () => {
      localStorage.removeItem('currentMission');
      localStorage.removeItem('missionLastDate');
      localStorage.removeItem('missionExp');
      currentMission = getCurrentMission();
      updateMissionUI();
      showPopup('Naloga ponastavljena');
      updateStats();
    });

    // Initial load
    updateEntriesList();
    updateStats();
    updateMissionUI();
    updateAchievements();

  </script>
</body>
</html>
